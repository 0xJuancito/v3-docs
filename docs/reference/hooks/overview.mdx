import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import { MultiLanguageExample } from "@site/src/components/InteractiveExample";

# Post-Dispatch Hooks

Post-dispatch hooks allow developers to configure additional origin chain behavior with message content dispatched via the Mailbox.

```mermaid
flowchart TB
    subgraph Origin
      Sender
      M_O[(Mailbox)]
      Hook[IPostDispatchHook]

      Sender -- "dispatch(..., metadata, hook)\n{value}" --> M_O
      M_O -- "postDispatch(message, metadata)\n{value}" --> Hook
    end
```

This allows developers to integrate third party/native bridges, make additional chain commitments, or require custom fees all while maintaining a consistent single-call Mailbox interface.

<details>
<summary>`IPostDispatchHook` Interface</summary>

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/hooks/IPostDispatchHook.sol
```

</TabItem>
</Tabs>
</details>

## Post Dispatch

In addition to the `message` dispatched via the Mailbox, the `postDispatch` function receives a `metadata` parameter. This is maximally flexible, allowing message senders to pass any context they wish through to the hook.

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/hooks/IPostDispatchHook.sol#L48-L51
```

</TabItem>
</Tabs>

**Parameters**

- `metadata`: The metadata required for the hook
- `message`: The message passed from the `dispatch` call

### Access Control

If the `postDispatch` must only be called with a `message` that was *just* dispatched, the `latestDispatchedId` function on the Mailbox can be used to verify the message was *actually* dispatched.

:::info
This is used instead of Mailbox access control to support **composition** where a hook may pass a `message` along to another hook.
:::

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

The following utility is provided in the [`MailboxClient` library](../libraries/mailboxclient.mdx) for convenience.
```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/client/MailboxClient.sol#L89-L91
```

</TabItem>
</Tabs>


## Quote Dispatch

Fees are often configured to cover protocol costs. These include transaction submission on the destination chain, security provisioning, and maintenance. To receive a quote for a corresponding `postDispatch` call, you can query the `quoteDispatch` function.

The Mailbox has a `quoteDispatch` entrypoint that which returns the aggregate fee required for a `dispatch` call to be successful. 

```mermaid
flowchart TB
    subgraph Origin
      Sender
      M_O[(Mailbox)]
      R_H[RequiredHook]
      Hook[CustomHook]

      Sender -- "quoteDispatch(..., metadata, hook)" --> M_O
      M_O -- "required = quoteDispatch(message, metadata)" --> R_H
      M_O -- "fee = hook.quoteDispatch(message, metadata)" --> Hook
      M_O -- "required + fee" --> Sender
    end
``` 

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/hooks/IPostDispatchHook.sol#L59-L62
```

</TabItem>
</Tabs>

**Parameters**

- `metadata`: The metadata required for the hook
- `message`: The message passed from the `dispatch` call

**Returns**

- `fee`: The fee required for the `postDispatch` call to be successful


## Default Hook Overrides

### Overriding default hook metadata

To override the default hook metadata, there is a `dispatch` overload that 1pts a `metadata` parameter to be used in the configured `defaultHook`.

```mermaid
flowchart LR
    subgraph Origin Chain
      Sender
      M_O[(Mailbox)]
      R_H[RequiredHook]
      D_H[DefaultHook]
      Sender -- "dispatch(..., metadata){value}" --> M_O

      M_O -. "fee = quoteDispatch(...)" .- R_H
      M_O -- "postDispatch(metadata, ...)\n{fee}" --> R_H
      M_O -. "postDispatch(metadata, ...)\n{value - fee}" ..-> D_H
    end
```

:::warning
Overriding the default hook metadata is an advanced feature. See the [Hooks](../hooks/overview.mdx) documentation for more information.
:::

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/Mailbox.sol#L125-L130

```

</TabItem>
</Tabs>

#### Examples

<MultiLanguageExample
  solidity={({
    mailbox,
    originChain,
    destinationDomain,
    destinationChain,
    paddedRecipient,
    body,
  }) => `\
// send message from ${originChain} to ${destinationChain} TestRecipient
IMailbox mailbox = IMailbox("${mailbox}");
bytes memory metadata = abi.encodePacked(StandardHookMetadata({
  variant: 1,
  msgValue: 0,
  gasLimit: 123456,         // override default gas limit
  refundAddress: msg.sender // override default refund address
});
mailbox.dispatch{value: msg.value}(
  ${destinationDomain},
  "${paddedRecipient}",
  bytes("${body}"),
  metadata
);
`}
/>

### Overriding the default hook and metadata

To override the default hook configuration, there is a `dispatch` overload that accepts a `hook` and hook `metadata` parameters.

```mermaid
flowchart LR
    subgraph Origin Chain
      Sender
      M_O[(Mailbox)]
      R_H[RequiredHook]
      D_H[DefaultHook]
      C_H[CustomHook]
      Sender -- "dispatch(..., metadata, hook){value}" --> M_O

      M_O -. "fee = quoteDispatch(...)" .- R_H
      M_O -- "postDispatch(metadata, ...)\n{fee}" --> R_H
      M_O -- "hook.postDispatch(metadata, ...)\n{value - fee}" ---> C_H
      M_O -.- D_H
    end
```

:::warning
Overriding the default hook is an advanced feature. See the [Hooks](../hooks/overview.mdx) documentation for more information.
:::

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/Mailbox.sol#L269-L275

```

#### Examples

<MultiLanguageExample
  solidity={({
    mailbox,
    merkleTreeHook,
    originChain,
    destinationDomain,
    destinationChain,
    paddedRecipient,
    body,
  }) => `\
// send message from ${originChain} to ${destinationChain} TestRecipient
IMailbox mailbox = IMailbox("${mailbox}");
IPostDispatchHook merkleTree = IPostDispatchHook("${merkleTreeHook}");
mailbox.dispatch(
  ${destinationDomain},
  "${paddedRecipient}",
  bytes("${body}"),
  "0x", // empty metadata
  merkleTree
);
`}
/>

</TabItem>
</Tabs>

